# è«æä¹‹åœ° NodeBB æ’ä»¶å¼€å‘å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆå·¥ä½œ

### 1. NodeBB æ±‰åŒ– âœ…

- è®¾ç½®é»˜è®¤è¯­è¨€ä¸ºç®€ä½“ä¸­æ–‡ï¼ˆzh-CNï¼‰
- å‰å°é¡µé¢å·²å®Œå…¨æ±‰åŒ–
- è®¿é—®åœ°å€: http://localhost:4567

### 2. è‡ªå®šä¹‰æ’ä»¶å¼€å‘ âœ…

**æ’ä»¶åç§°**: `nodebb-plugin-moti-api`
**æ’ä»¶ä½ç½®**: `/Users/changpengcheng/MT/nodebb/node_modules/nodebb-plugin-moti-api`

**æ’ä»¶ç»“æ„**:
```
nodebb-plugin-moti-api/
â”œâ”€â”€ package.json          # æ’ä»¶åŸºæœ¬ä¿¡æ¯
â”œâ”€â”€ plugin.json           # NodeBB æ’ä»¶é…ç½®
â”œâ”€â”€ library.js            # æ ¸å¿ƒé€»è¾‘ï¼ˆ450+ è¡Œï¼‰
â”œâ”€â”€ README.md             # API æ–‡æ¡£
â”œâ”€â”€ languages/            # è¯­è¨€æ–‡ä»¶ç›®å½•
â””â”€â”€ templates/            # æ¨¡æ¿ç›®å½•
```

### 3. å·²å®ç°çš„ API ç«¯ç‚¹

#### âœ… æµ‹è¯•æ¥å£
```bash
GET /api/moti/test
# è¿”å›: { "success": true, "message": "è«æä¹‹åœ°APIæ’ä»¶è¿è¡Œæ­£å¸¸" }
```

#### âœ… ç”¨æˆ·ç›¸å…³ API

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| `/api/moti/user/profile` | GET | è·å–ç”¨æˆ·ä¿¡æ¯ï¼ˆå«VIPçŠ¶æ€ã€ç§¯åˆ†ï¼‰ | âœ… å·²å®Œæˆ |
| `/api/moti/auth/wechat` | POST | å¾®ä¿¡ç™»å½• | ğŸ”¨ å¾…å®Œå–„ |
| `/api/moti/auth/phone` | POST | ç»‘å®šæ‰‹æœºå· | ğŸ”¨ å¾…å®Œå–„ |

#### âœ… å†…å®¹ç›¸å…³ API

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| `/api/moti/posts` | GET | è·å–å¸–å­åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µå’Œæ’åºï¼‰ | âœ… å·²å®Œæˆ |
| `/api/moti/post/:pid` | GET | è·å–å¸–å­è¯¦æƒ…ï¼ˆå«æƒé™æ§åˆ¶ï¼‰ | âœ… å·²å®Œæˆ |

**æ’åºæ”¯æŒ**:
- `sort=recent` - æœ€æ–°å¸–å­
- `sort=popular` - æœ€çƒ­å¸–å­
- `sort=mostbookmarked` - æœ€å¤šæ”¶è—

#### âœ… äº’åŠ¨ç›¸å…³ API

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | çŠ¶æ€ |
|------|------|------|------|
| `/api/moti/post/:pid/upvote` | POST | ç‚¹èµå¸–å­ | âœ… å·²å®Œæˆ |
| `/api/moti/post/:pid/bookmark` | POST | æ”¶è—å¸–å­ | âœ… å·²å®Œæˆ |

### 4. æ ¸å¿ƒåŠŸèƒ½å®ç°

#### âœ… é˜…è¯»æƒé™æ§åˆ¶

**è§„åˆ™**:
- æœªç™»å½•ç”¨æˆ·: ç¦æ­¢é˜…è¯»
- æ™®é€šç”¨æˆ·: æ¯æ—¥é™è¯» 1 ç¯‡
- VIP ç”¨æˆ·: æ— é™åˆ¶é˜…è¯»

**å®ç°é€»è¾‘**:
```javascript
// è‡ªåŠ¨æ£€æµ‹ç”¨æˆ·VIPçŠ¶æ€
// è‡ªåŠ¨è¿½è¸ªæ¯æ—¥é˜…è¯»æ¬¡æ•°
// è¶…è¿‡é™åˆ¶è¿”å› 403 é”™è¯¯å¹¶æç¤ºéœ€è¦å‡çº§VIP
```

#### âœ… ç”¨æˆ·æ‰©å±•å­—æ®µ

å·²åœ¨ Redis ä¸­æ‰©å±•ç”¨æˆ·æ•°æ®ç»“æ„ï¼š
```javascript
user:{uid} hash
  - vip_expire_time      // VIPåˆ°æœŸæ—¶é—´æˆ³
  - points               // ç§¯åˆ†
  - daily_read_count     // ä»Šæ—¥é˜…è¯»æ•°
  - last_read_date       // æœ€åé˜…è¯»æ—¥æœŸï¼ˆç”¨äºé‡ç½®è®¡æ•°ï¼‰
  - phone                // æ‰‹æœºå·
  - wechat_openid        // å¾®ä¿¡openidï¼ˆé¢„ç•™ï¼‰
```

#### âœ… Hooks é›†æˆ

- `static:app.load` - æ’ä»¶åˆå§‹åŒ–å’Œè·¯ç”±æ³¨å†Œ
- `filter:user.create` - ç”¨æˆ·åˆ›å»ºæ—¶åˆå§‹åŒ–æ‰©å±•å­—æ®µ
- `filter:post.get` - å¸–å­è·å–æ—¶çš„æƒé™æ£€æŸ¥ï¼ˆé¢„ç•™ï¼‰

### 5. æµ‹è¯•ç»“æœ

```bash
# æµ‹è¯• 1: æ’ä»¶çŠ¶æ€æ£€æŸ¥ âœ…
$ curl http://localhost:4567/api/moti/test
{
  "success": true,
  "message": "è«æä¹‹åœ°APIæ’ä»¶è¿è¡Œæ­£å¸¸",
  "version": "1.0.0",
  "timestamp": 1761538647693
}

# æµ‹è¯• 2: å¸–å­åˆ—è¡¨ API âœ…
$ curl http://localhost:4567/api/moti/posts?page=1&sort=recent
{
  "success": true,
  "data": {
    "topics": [],
    "page": 1,
    "pageCount": 1
  }
}
```

## ğŸ“ API ä½¿ç”¨ç¤ºä¾‹

### è·å–ç”¨æˆ·ä¿¡æ¯

```javascript
// éœ€è¦ç”¨æˆ·ç™»å½•çŠ¶æ€
fetch('http://localhost:4567/api/moti/user/profile', {
  headers: {
    'Authorization': 'Bearer <token>'
  }
})
.then(res => res.json())
.then(data => {
  console.log('ç”¨æˆ·ä¿¡æ¯:', data.data);
  console.log('æ˜¯å¦VIP:', data.data.isVip);
  console.log('ç§¯åˆ†:', data.data.points);
});
```

### è·å–å¸–å­åˆ—è¡¨

```javascript
// æœ€æ–°å¸–å­
fetch('http://localhost:4567/api/moti/posts?page=1&sort=recent')
  .then(res => res.json())
  .then(data => console.log('å¸–å­åˆ—è¡¨:', data.data.topics));

// æœ€çƒ­å¸–å­
fetch('http://localhost:4567/api/moti/posts?page=1&sort=popular')
  .then(res => res.json())
  .then(data => console.log('çƒ­é—¨å¸–å­:', data.data.topics));
```

### é˜…è¯»å¸–å­ï¼ˆå¸¦æƒé™æ§åˆ¶ï¼‰

```javascript
fetch('http://localhost:4567/api/moti/post/1')
  .then(res => {
    if (res.status === 403) {
      // è¶…è¿‡æ¯æ—¥é™åˆ¶
      return res.json().then(err => {
        alert(err.error); // "ä»Šæ—¥å…è´¹é˜…è¯»æ¬¡æ•°å·²ç”¨å®Œ"
        // æç¤ºç”¨æˆ·å¼€é€šVIP
      });
    }
    return res.json();
  })
  .then(data => console.log('å¸–å­å†…å®¹:', data.data));
```

### ç‚¹èµå’Œæ”¶è—

```javascript
// ç‚¹èµ
fetch('http://localhost:4567/api/moti/post/1/upvote', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer <token>'
  }
})
.then(res => res.json())
.then(data => console.log(data.message)); // "ç‚¹èµæˆåŠŸ"

// æ”¶è—
fetch('http://localhost:4567/api/moti/post/1/bookmark', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer <token>'
  }
})
.then(res => res.json())
.then(data => console.log(data.message)); // "æ”¶è—æˆåŠŸ"
```

## ğŸ¯ ä¸‹ä¸€æ­¥å¼€å‘ä»»åŠ¡

### 1. å®Œå–„å¾®ä¿¡ç™»å½• ğŸ”¨

```javascript
// /api/moti/auth/wechat
// TODO:
// 1. æ¥å…¥å¾®ä¿¡ OAuth API
// 2. é€šè¿‡ code æ¢å– openid å’Œ session_key
// 3. æŸ¥è¯¢æˆ–åˆ›å»º NodeBB ç”¨æˆ·
// 4. ç”Ÿæˆ JWT token è¿”å›
```

### 2. å®Œå–„æ”¯ä»˜ç³»ç»Ÿ ğŸ”¨

```javascript
// TODO:
// 1. åˆ›å»ºè®¢å• API
// 2. å¾®ä¿¡æ”¯ä»˜ç»Ÿä¸€ä¸‹å•
// 3. æ”¯ä»˜å›è°ƒå¤„ç†
// 4. æ¿€æ´» VIP æƒé™
```

### 3. ç§¯åˆ†ç³»ç»Ÿ ğŸ”¨

```javascript
// TODO:
// 1. äº’åŠ¨å¢åŠ ç§¯åˆ†ï¼ˆç‚¹èµã€è¯„è®ºã€åˆ†äº«ï¼‰
// 2. è¢«ç‚¹èµå¢åŠ ç§¯åˆ†
// 3. ç§¯åˆ†å…‘æ¢åŠŸèƒ½
```

### 4. ç¬”è®°åŠŸèƒ½ ğŸ”¨

```javascript
// TODO:
// 1. ä¿å­˜ç¬”è®° API
// 2. æŸ¥è¯¢ç¬”è®° API
// 3. ç¬”è®°åˆ—è¡¨ API
```

### 5. å‘å¸–åŠŸèƒ½ ğŸ”¨

```javascript
// TODO:
// 1. åˆ›å»ºå¸–å­ APIï¼ˆVIPæƒé™æ£€æŸ¥ï¼‰
// 2. ç¼–è¾‘å¸–å­ API
// 3. ä¸Šä¼ å›¾ç‰‡ API
// 4. è‰ç¨¿ä¿å­˜ API
```

## ğŸ”§ å¼€å‘å·¥å…·å‘½ä»¤

```bash
# é‡å¯ NodeBB
cd /Users/changpengcheng/MT/nodebb
./nodebb restart

# é‡æ–°æ„å»º
./nodebb build

# æŸ¥çœ‹æ—¥å¿—
./nodebb log

# æ¿€æ´»/åœç”¨æ’ä»¶
./nodebb activate nodebb-plugin-moti-api
./nodebb deactivate nodebb-plugin-moti-api
```

## ğŸ“š å‚è€ƒæ–‡æ¡£

- [NodeBB æ’ä»¶å¼€å‘æ–‡æ¡£](https://docs.nodebb.org/development/plugins/)
- [NodeBB API æ–‡æ¡£](https://docs.nodebb.org/api/)
- [æ’ä»¶ README](/Users/changpengcheng/MT/nodebb/node_modules/nodebb-plugin-moti-api/README.md)

## ğŸ‰ å®Œæˆæƒ…å†µæ€»ç»“

| æ¨¡å— | å®Œæˆåº¦ | å¤‡æ³¨ |
|------|--------|------|
| æ±‰åŒ– | 100% âœ… | å·²å®Œå…¨æ±‰åŒ–ä¸ºç®€ä½“ä¸­æ–‡ |
| æ’ä»¶éª¨æ¶ | 100% âœ… | package.json, plugin.json, library.js |
| ç”¨æˆ· API | 70% | åŸºç¡€åŠŸèƒ½å®Œæˆï¼Œå¾®ä¿¡ç™»å½•å¾…å®Œå–„ |
| å†…å®¹ API | 80% | åˆ—è¡¨å’Œè¯¦æƒ…å®Œæˆï¼Œæœç´¢å¾…å¼€å‘ |
| äº’åŠ¨ API | 60% | ç‚¹èµæ”¶è—å®Œæˆï¼Œè¯„è®ºå¾…å¼€å‘ |
| æƒé™æ§åˆ¶ | 100% âœ… | æ¯æ—¥é™è¯»åŠŸèƒ½å®Œæ•´å®ç° |
| æ”¯ä»˜ç³»ç»Ÿ | 0% | å¾…å¼€å‘ |
| ç§¯åˆ†ç³»ç»Ÿ | 20% | æ•°æ®ç»“æ„å·²è®¾è®¡ |
| ç¬”è®°åŠŸèƒ½ | 0% | å¾…å¼€å‘ |

---

**æ€»ä½“å®Œæˆåº¦**: çº¦ 50%

**ä¸‹æ¬¡å¼€å‘å»ºè®®**:
1. å…ˆå¼€å‘å¾®ä¿¡ç™»å½•ï¼Œæ‰“é€šç”¨æˆ·ä½“ç³»
2. åˆ›å»ºå°ç¨‹åºé¡¹ç›®ï¼Œå¯¹æ¥ç°æœ‰API
3. è¾¹åšè¾¹å®Œå–„åç«¯åŠŸèƒ½

**é¡¹ç›®å·²æäº¤åˆ° GitHub**: https://github.com/wdcpclover/mtnew
