<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>åˆ’çº¿ç¬”è®°åŠŸèƒ½æ¼”ç¤º - è«æä¹‹åœ°</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
      line-height: 1.8;
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      overflow: hidden;
    }

    header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      text-align: center;
    }

    header h1 {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    header p {
      font-size: 1rem;
      opacity: 0.9;
    }

    .toolbar {
      background: #f8f9fa;
      padding: 15px 30px;
      border-bottom: 1px solid #dee2e6;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .toolbar button {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .btn-highlight {
      background: #ffd700;
      color: #333;
    }

    .btn-highlight:hover {
      background: #ffed4e;
      transform: translateY(-2px);
    }

    .btn-clear {
      background: #dc3545;
      color: white;
    }

    .btn-clear:hover {
      background: #c82333;
    }

    .btn-save {
      background: #28a745;
      color: white;
    }

    .btn-save:hover {
      background: #218838;
    }

    .color-picker {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .color-option {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      border: 3px solid transparent;
      transition: all 0.2s;
    }

    .color-option:hover {
      transform: scale(1.1);
    }

    .color-option.active {
      border-color: #333;
      box-shadow: 0 0 0 2px white, 0 0 0 4px #333;
    }

    .content {
      padding: 40px;
    }

    .article {
      font-size: 18px;
      line-height: 2;
      color: #333;
      user-select: text;
    }

    .article h2 {
      font-size: 24px;
      margin-top: 30px;
      margin-bottom: 15px;
      color: #667eea;
    }

    .article p {
      margin-bottom: 20px;
      text-indent: 2em;
    }

    .highlight {
      padding: 2px 0;
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }

    .highlight:hover::after {
      content: 'ğŸ“';
      position: absolute;
      right: -20px;
      top: -2px;
      font-size: 14px;
    }

    .note-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      z-index: 1000;
      display: none;
      min-width: 400px;
    }

    .note-panel.active {
      display: block;
    }

    .note-panel h3 {
      margin-bottom: 15px;
      color: #667eea;
    }

    .note-panel .selected-text {
      background: #f8f9fa;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid #667eea;
      font-size: 14px;
      color: #666;
    }

    .note-panel textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    .note-panel .buttons {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      justify-content: flex-end;
    }

    .note-panel button {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
    }

    .btn-save-note {
      background: #667eea;
      color: white;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 999;
      display: none;
    }

    .overlay.active {
      display: block;
    }

    .notes-list {
      background: #f8f9fa;
      padding: 30px;
      border-top: 1px solid #dee2e6;
    }

    .notes-list h3 {
      color: #667eea;
      margin-bottom: 20px;
    }

    .note-item {
      background: white;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 15px;
      border-left: 4px solid;
    }

    .note-item .note-content {
      font-size: 14px;
      color: #666;
      margin-bottom: 10px;
      font-style: italic;
    }

    .note-item .note-text {
      font-size: 16px;
      color: #333;
      margin-bottom: 10px;
    }

    .note-item .note-actions {
      display: flex;
      gap: 10px;
    }

    .note-item button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }

    .btn-delete {
      background: #dc3545;
      color: white;
    }

    .btn-edit {
      background: #ffc107;
      color: #333;
    }

    .status {
      padding: 10px 20px;
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      border-radius: 6px;
      color: #0c5460;
      font-size: 14px;
    }

    .status.success {
      background: #d4edda;
      border-color: #c3e6cb;
      color: #155724;
    }

    .status.error {
      background: #f8d7da;
      border-color: #f5c6cb;
      color: #721c24;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ“ åˆ’çº¿ç¬”è®°åŠŸèƒ½æ¼”ç¤º</h1>
      <p>é€‰ä¸­æ–‡ç« ä¸­çš„æ–‡å­—ï¼Œç‚¹å‡»é«˜äº®æŒ‰é’®å³å¯æ·»åŠ ç¬”è®°</p>
    </header>

    <div class="toolbar">
      <button class="btn-highlight" onclick="highlightSelection()">âœ¨ é«˜äº®é€‰ä¸­æ–‡å­—</button>

      <div class="color-picker">
        <span style="font-size: 14px; color: #666;">é¢œè‰²:</span>
        <div class="color-option active" style="background: #ffeb3b;" data-color="#ffeb3b" onclick="selectColor(this)"></div>
        <div class="color-option" style="background: #4caf50;" data-color="#4caf50" onclick="selectColor(this)"></div>
        <div class="color-option" style="background: #ff5722;" data-color="#ff5722" onclick="selectColor(this)"></div>
        <div class="color-option" style="background: #2196f3;" data-color="#2196f3" onclick="selectColor(this)"></div>
        <div class="color-option" style="background: #e91e63;" data-color="#e91e63" onclick="selectColor(this)"></div>
      </div>

      <button class="btn-clear" onclick="clearAllHighlights()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰é«˜äº®</button>
      <button class="btn-save" onclick="saveAllNotes()">ğŸ’¾ ä¿å­˜æ‰€æœ‰ç¬”è®°</button>

      <div class="status" id="status"></div>
    </div>

    <div class="content">
      <article class="article" id="article">
        <h2>è«æä¹‹åœ°çš„ä¼ è¯´</h2>
        <p>åœ¨é¥è¿œçš„ä¸œæ–¹ï¼Œæœ‰ä¸€ç‰‡ç¥ç§˜çš„åœŸåœ°ï¼Œäººä»¬ç§°ä¹‹ä¸º"è«æä¹‹åœ°"ã€‚è¿™é‡Œå››å­£å¦‚æ˜¥ï¼Œå±±å·ç§€ç¾ï¼Œæ˜¯ä¸€ä¸ªå……æ»¡æ™ºæ…§å’Œä¼ å¥‡çš„åœ°æ–¹ã€‚</p>

        <p>æ®å¤è€çš„ä¼ è¯´è®°è½½ï¼Œè«æä¹‹åœ°åŸæœ¬æ˜¯ä¸€ç‰‡è’èŠœä¹‹åœ°ã€‚ç„¶è€Œï¼Œä¸€ä½æ™ºè€…æ¥åˆ°è¿™é‡Œï¼Œç”¨ä»–çš„æ™ºæ…§å’ŒçŸ¥è¯†æ”¹å˜äº†è¿™ç‰‡åœŸåœ°çš„å‘½è¿ã€‚ä»–æ•™å¯¼äººä»¬å¦‚ä½•è€•ç§ã€å¦‚ä½•å»ºé€ ã€å¦‚ä½•ç”Ÿæ´»ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œä»–æ•™ä¼šäº†äººä»¬å¦‚ä½•æ€è€ƒã€‚</p>

        <h2>çŸ¥è¯†çš„åŠ›é‡</h2>
        <p>æ™ºè€…å»ºç«‹äº†ä¸€åº§å®ä¼Ÿçš„å›¾ä¹¦é¦†ï¼Œæ”¶è—äº†ä¸–ç•Œå„åœ°çš„çŸ¥è¯†å’Œæ™ºæ…§ã€‚ä»–ç›¸ä¿¡ï¼ŒçŸ¥è¯†æ˜¯æ”¹å˜ä¸–ç•Œæœ€å¼ºå¤§çš„åŠ›é‡ã€‚æ¯ä¸ªæ¥åˆ°è«æä¹‹åœ°çš„äººï¼Œéƒ½å¯ä»¥å…è´¹è¿›å…¥å›¾ä¹¦é¦†å­¦ä¹ ï¼Œæ±²å–çŸ¥è¯†çš„å…»åˆ†ã€‚</p>

        <p>éšç€æ—¶é—´çš„æ¨ç§»ï¼Œè«æä¹‹åœ°å˜å¾—è¶Šæ¥è¶Šç¹è£ã€‚è¿™é‡Œçš„äººä»¬ä¸ä»…æ‹¥æœ‰ä¸°å¯Œçš„ç‰©è´¨ç”Ÿæ´»ï¼Œæ›´é‡è¦çš„æ˜¯ï¼Œä»–ä»¬æ‹¥æœ‰å¼€æ”¾çš„æ€æƒ³å’Œæ±‚çŸ¥çš„ç²¾ç¥ã€‚ä»–ä»¬ç›¸äº’åˆ†äº«çŸ¥è¯†ï¼Œå…±åŒè¿›æ­¥ï¼Œåˆ›é€ äº†ä¸€ä¸ªçœŸæ­£çš„çŸ¥è¯†ä¹å›­ã€‚</p>

        <h2>æ°¸æ’çš„ä¼ æ‰¿</h2>
        <p>æ™ºè€…ç¦»å¼€åï¼Œè«æä¹‹åœ°çš„äººä»¬ç»§ç»­ä¼ æ‰¿ç€ä»–çš„æ•™è¯²ã€‚ä»–ä»¬æ˜ç™½ï¼ŒçœŸæ­£çš„è´¢å¯Œä¸æ˜¯é‡‘é“¶è´¢å®ï¼Œè€Œæ˜¯å¤´è„‘ä¸­çš„çŸ¥è¯†å’Œå¿ƒä¸­çš„æ™ºæ…§ã€‚æ¯ä¸€ä»£äººéƒ½åœ¨ä¸ºä¸‹ä¸€ä»£ç§¯ç´¯æ›´å¤šçš„çŸ¥è¯†ï¼Œè®©è«æä¹‹åœ°çš„ä¼ è¯´æ°¸è¿œæµä¼ ä¸‹å»ã€‚</p>

        <p>ä»Šå¤©ï¼Œå½“æˆ‘ä»¬è°ˆè®ºè«æä¹‹åœ°æ—¶ï¼Œä¸ä»…æ˜¯åœ¨è®²è¿°ä¸€ä¸ªå¤è€çš„ä¼ è¯´ï¼Œæ›´æ˜¯åœ¨ä¼ é€’ä¸€ç§ç²¾ç¥â€”â€”å¯¹çŸ¥è¯†çš„æ¸´æœ›ï¼Œå¯¹æ™ºæ…§çš„è¿½æ±‚ï¼Œå¯¹åˆ†äº«çš„çƒ­çˆ±ã€‚è¿™å°±æ˜¯è«æä¹‹åœ°æœ€çè´µçš„é—äº§ã€‚</p>
      </article>
    </div>

    <div class="notes-list" id="notesList">
      <h3>æˆ‘çš„ç¬”è®° (<span id="notesCount">0</span>)</h3>
      <div id="notesContainer"></div>
    </div>
  </div>

  <div class="overlay" id="overlay" onclick="closeNotePanel()"></div>

  <div class="note-panel" id="notePanel">
    <h3>æ·»åŠ ç¬”è®°</h3>
    <div class="selected-text" id="selectedText"></div>
    <textarea id="noteInput" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æƒ³æ³•å’Œç¬”è®°..."></textarea>
    <div class="buttons">
      <button class="btn-cancel" onclick="closeNotePanel()">å–æ¶ˆ</button>
      <button class="btn-save-note" onclick="saveNote()">ä¿å­˜ç¬”è®°</button>
    </div>
  </div>

  <script>
    let currentColor = '#ffeb3b';
    let highlights = [];
    let currentSelection = null;

    // é€‰æ‹©é¢œè‰²
    function selectColor(element) {
      document.querySelectorAll('.color-option').forEach(el => el.classList.remove('active'));
      element.classList.add('active');
      currentColor = element.dataset.color;
    }

    // é«˜äº®é€‰ä¸­æ–‡å­—
    function highlightSelection() {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        showStatus('è¯·å…ˆé€‰ä¸­ä¸€æ®µæ–‡å­—', 'error');
        return;
      }

      const range = selection.getRangeAt(0);
      const selectedText = selection.toString().trim();

      if (!selectedText) {
        showStatus('é€‰ä¸­çš„æ–‡å­—ä¸èƒ½ä¸ºç©º', 'error');
        return;
      }

      // ä¿å­˜å½“å‰é€‰æ‹©ä¿¡æ¯
      currentSelection = {
        text: selectedText,
        range: range.cloneRange(),
        color: currentColor
      };

      // æ˜¾ç¤ºç¬”è®°é¢æ¿
      document.getElementById('selectedText').textContent = `"${selectedText}"`;
      document.getElementById('overlay').classList.add('active');
      document.getElementById('notePanel').classList.add('active');
      document.getElementById('noteInput').value = '';
      document.getElementById('noteInput').focus();
    }

    // ä¿å­˜ç¬”è®°
    function saveNote() {
      const noteText = document.getElementById('noteInput').value.trim();

      if (!currentSelection) {
        showStatus('æ²¡æœ‰é€‰ä¸­çš„æ–‡å­—', 'error');
        return;
      }

      // åˆ›å»ºé«˜äº®å…ƒç´ 
      const span = document.createElement('span');
      span.className = 'highlight';
      span.style.backgroundColor = currentSelection.color;
      span.textContent = currentSelection.text;

      // æ›¿æ¢é€‰ä¸­çš„æ–‡å­—
      try {
        currentSelection.range.deleteContents();
        currentSelection.range.insertNode(span);
      } catch (e) {
        console.error('æ’å…¥é«˜äº®å¤±è´¥:', e);
        showStatus('æ·»åŠ é«˜äº®å¤±è´¥ï¼Œè¯·é‡è¯•', 'error');
        closeNotePanel();
        return;
      }

      // ä¿å­˜ç¬”è®°ä¿¡æ¯
      const highlight = {
        id: Date.now(),
        text: currentSelection.text,
        note: noteText,
        color: currentSelection.color,
        timestamp: new Date().toLocaleString('zh-CN')
      };

      highlights.push(highlight);

      // æ˜¾ç¤ºç¬”è®°
      renderNotes();

      // å…³é—­é¢æ¿
      closeNotePanel();

      showStatus('ç¬”è®°æ·»åŠ æˆåŠŸï¼', 'success');

      // æ¸…é™¤é€‰æ‹©
      window.getSelection().removeAllRanges();
    }

    // å…³é—­ç¬”è®°é¢æ¿
    function closeNotePanel() {
      document.getElementById('overlay').classList.remove('active');
      document.getElementById('notePanel').classList.remove('active');
      currentSelection = null;
    }

    // æ¸²æŸ“ç¬”è®°åˆ—è¡¨
    function renderNotes() {
      const container = document.getElementById('notesContainer');
      const count = document.getElementById('notesCount');

      count.textContent = highlights.length;

      if (highlights.length === 0) {
        container.innerHTML = '<p style="color: #999; text-align: center;">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ç¬”è®°</p>';
        return;
      }

      container.innerHTML = highlights.map(h => `
        <div class="note-item" style="border-left-color: ${h.color};">
          <div class="note-content">"${h.text}"</div>
          ${h.note ? `<div class="note-text">${h.note}</div>` : '<div class="note-text" style="color: #999;">ï¼ˆæ— ç¬”è®°ï¼‰</div>'}
          <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${h.timestamp}</div>
          <div class="note-actions">
            <button class="btn-delete" onclick="deleteNote(${h.id})">åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    // åˆ é™¤ç¬”è®°
    function deleteNote(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) return;

      highlights = highlights.filter(h => h.id !== id);
      renderNotes();
      showStatus('ç¬”è®°å·²åˆ é™¤', 'success');
    }

    // æ¸…é™¤æ‰€æœ‰é«˜äº®
    function clearAllHighlights() {
      if (highlights.length === 0) {
        showStatus('æ²¡æœ‰å¯æ¸…é™¤çš„é«˜äº®', 'error');
        return;
      }

      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é«˜äº®å’Œç¬”è®°å—ï¼Ÿ')) return;

      // é‡æ–°åŠ è½½æ–‡ç« å†…å®¹
      location.reload();
    }

    // ä¿å­˜æ‰€æœ‰ç¬”è®°åˆ°æœåŠ¡å™¨
    async function saveAllNotes() {
      if (highlights.length === 0) {
        showStatus('æ²¡æœ‰å¯ä¿å­˜çš„ç¬”è®°', 'error');
        return;
      }

      showStatus('æ­£åœ¨ä¿å­˜ç¬”è®°...', '');

      try {
        // è¿™é‡Œå¯ä»¥è°ƒç”¨çœŸå®çš„APIä¿å­˜ç¬”è®°
        // ç°åœ¨åªæ˜¯æ¨¡æ‹Ÿä¿å­˜
        await new Promise(resolve => setTimeout(resolve, 1000));

        showStatus(`æˆåŠŸä¿å­˜ ${highlights.length} æ¡ç¬”è®°ï¼`, 'success');

        // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨ç±»ä¼¼è¿™æ ·çš„APIï¼š
        // for (const highlight of highlights) {
        //   await fetch('http://localhost:4567/api/moti/notes', {
        //     method: 'POST',
        //     headers: { 'Content-Type': 'application/json' },
        //     body: JSON.stringify({
        //       pid: 1, // å¸–å­ID
        //       content: highlight.text,
        //       note: highlight.note,
        //       color: highlight.color,
        //       startOffset: 0,
        //       endOffset: highlight.text.length
        //     })
        //   });
        // }

      } catch (error) {
        showStatus('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
      }
    }

    // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
    function showStatus(message, type) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status';
      if (type) status.classList.add(type);

      if (message) {
        setTimeout(() => {
          status.textContent = '';
          status.className = 'status';
        }, 3000);
      }
    }

    // åˆå§‹åŒ–
    renderNotes();
  </script>
</body>
</html>
