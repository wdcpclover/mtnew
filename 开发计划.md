# 莫提之地小程序开发计划

## 项目概况

**项目名称**: 莫提之地小程序
**后端架构**: NodeBB v4.6.1 (已搭建完成)
**前端架构**: 微信小程序 + 小程序管理后台
**开发周期**: 预计 5-7 周

---

## 一、技术架构设计

### 1.1 整体架构

```
┌─────────────────┐      ┌──────────────────┐      ┌─────────────┐
│   微信小程序端   │ ←──→ │   NodeBB API层   │ ←──→ │   Redis DB  │
└─────────────────┘      └──────────────────┘      └─────────────┘
        ↓                         ↓
┌─────────────────┐      ┌──────────────────┐
│ 小程序管理后台   │ ←──→ │  NodeBB Admin    │
└─────────────────┘      └──────────────────┘
```

### 1.2 技术栈选型

**后端 (已完成)**
- NodeBB 4.6.1
- Node.js 23.x
- Redis 数据库
- Express.js 框架

**小程序端 (待开发)**
- 微信原生小程序 / uni-app (推荐uni-app，可后续扩展到支付宝小程序)
- 状态管理: Pinia / Vuex
- UI框架: uView UI / Vant Weapp
- 网络请求: axios / uni.request

**管理后台 (可选)**
- 直接使用 NodeBB Admin
- 或自建: Vue3 + Element Plus + NodeBB API

---

## 二、开发阶段规划

### 📋 第一阶段：基础架构搭建 (第1-2周)

#### 1.1 NodeBB 定制化开发

**目标**: 让 NodeBB 满足小程序的业务需求

- [ ] **扩展 NodeBB API**
  - 开发自定义插件 `nodebb-plugin-moti-api`
  - 实现小程序专用的 RESTful API
  - 添加微信登录适配接口

- [ ] **用户系统改造**
  - 集成微信 OAuth 登录
  - 添加手机号验证功能
  - 实现用户付费状态标记
  - 开发积分系统扩展

- [ ] **权限控制系统**
  - 未付费用户：每日限读1篇
  - 付费用户：无限制阅读 + 发帖权限
  - 开发阅读记录追踪功能

**技术要点**:
```javascript
// nodebb/src/plugins/moti-api/library.js
plugin.init = async (params) => {
  const router = params.router;
  const middleware = params.middleware;

  // 小程序专用API路由
  router.get('/api/moti/posts', middleware.authenticate, getPosts);
  router.post('/api/moti/login/wechat', wechatLogin);
  // ...
};
```

#### 1.2 小程序端初始化

- [ ] **创建小程序项目**
  - 申请微信小程序账号
  - 初始化 uni-app 项目
  - 配置开发环境

- [ ] **基础架构搭建**
  - 封装 API 请求模块
  - 配置路由和页面结构
  - 集成 UI 组件库
  - 实现全局状态管理

**目录结构**:
```
miniprogram/
├── pages/              # 页面
│   ├── index/         # 首页
│   ├── post/          # 帖子详情
│   ├── user/          # 个人中心
│   └── login/         # 登录页
├── components/         # 组件
├── api/               # API接口
├── store/             # 状态管理
├── utils/             # 工具函数
└── static/            # 静态资源
```

---

### 📋 第二阶段：核心功能开发 (第3-4周)

#### 2.1 用户系统 (3天)

**小程序端**:
- [ ] 微信授权登录页面
- [ ] 手机号验证流程
- [ ] 个人中心页面
- [ ] 个人资料编辑
- [ ] 付费记录查看
- [ ] 积分展示

**NodeBB 后端**:
- [ ] 微信登录 API (`POST /api/moti/auth/wechat`)
- [ ] 手机号绑定 API (`POST /api/moti/auth/phone`)
- [ ] 用户信息 API (`GET /api/moti/user/profile`)
- [ ] 积分系统 API

**数据表设计**:
```javascript
// Redis Keys
user:{uid}:wechat_openid   // 微信openid
user:{uid}:phone           // 手机号
user:{uid}:vip_expire      // 会员到期时间
user:{uid}:daily_reads     // 今日已读数量
user:{uid}:points          // 积分
```

#### 2.2 内容浏览系统 (4天)

**小程序端**:
- [ ] 帖子列表页（瀑布流/列表）
- [ ] 搜索功能
- [ ] 筛选器（最新/最热/最多收藏/时间/话题）
- [ ] 帖子详情页
- [ ] 已读/未读标记
- [ ] 阅读权限控制（付费墙）

**NodeBB 后端**:
- [ ] 帖子列表 API (`GET /api/moti/posts`)
  - 支持分页
  - 支持排序（newest/popular/mostbookmarked）
  - 支持话题筛选
  - 支持时间范围筛选
- [ ] 搜索 API (`GET /api/moti/search`)
- [ ] 帖子详情 API (`GET /api/moti/post/:pid`)
- [ ] 阅读权限校验中间件
- [ ] 阅读记录追踪

#### 2.3 互动功能 (3天)

**小程序端**:
- [ ] 点赞功能
- [ ] 评论列表和发表评论
- [ ] 收藏功能
- [ ] 分享功能
- [ ] 举报功能
- [ ] 互动记录查看

**NodeBB 后端**:
- [ ] 点赞 API (`POST /api/moti/post/:pid/upvote`)
- [ ] 评论 API (`POST /api/moti/post/:pid/comment`)
- [ ] 收藏 API (`POST /api/moti/post/:pid/bookmark`)
- [ ] 互动记录 API (`GET /api/moti/user/interactions`)

#### 2.4 发帖功能 (2天)

**小程序端**:
- [ ] 发帖编辑器（付费用户可见）
- [ ] 话题选择
- [ ] 图片上传
- [ ] 草稿保存

**NodeBB 后端**:
- [ ] 创建帖子 API (`POST /api/moti/posts/create`)
- [ ] 上传图片 API (`POST /api/moti/upload`)
- [ ] 草稿保存 API

#### 2.5 高级功能 - 划线笔记 (2天)

**小程序端**:
- [ ] 文本选择划线
- [ ] 笔记编辑器
- [ ] 笔记列表查看
- [ ] 笔记管理

**NodeBB 后端**:
- [ ] 笔记保存 API (`POST /api/moti/notes`)
- [ ] 笔记查询 API (`GET /api/moti/notes`)

**数据结构**:
```javascript
{
  noteId: "note_uuid",
  uid: 1,
  pid: 123,
  content: "被划线的文本内容",
  note: "用户的笔记",
  startOffset: 100,
  endOffset: 150,
  color: "#ffeb3b",
  timestamp: 1234567890
}
```

---

### 📋 第三阶段：支付系统 (第5周)

#### 3.1 微信支付集成 (5天)

**小程序端**:
- [ ] 付费套餐展示页
- [ ] 订单确认页
- [ ] 支付结果页
- [ ] 订单记录查看

**NodeBB 后端**:
- [ ] 创建订单 API (`POST /api/moti/orders/create`)
- [ ] 微信支付统一下单
- [ ] 支付回调处理 (`POST /api/moti/payment/callback`)
- [ ] 订单状态查询 API
- [ ] 会员权限激活

**支付流程**:
```
1. 小程序调用创建订单API
2. 后端调用微信支付统一下单
3. 返回支付参数给小程序
4. 小程序调起微信支付
5. 微信回调后端
6. 后端激活会员权限
7. 通知小程序支付结果
```

---

### 📋 第四阶段：管理后台 (第6周)

#### 4.1 内容管理

- [ ] 帖子列表管理
- [ ] 帖子编辑/删除/置顶
- [ ] 批量操作
- [ ] 话题管理

#### 4.2 用户管理

- [ ] 用户列表
- [ ] 用户详情查看
- [ ] 会员管理
- [ ] 积分管理

#### 4.3 评论管理

- [ ] 评论审核
- [ ] 评论删除
- [ ] 评论置顶

#### 4.4 数据统计

- [ ] 用户增长统计
- [ ] 内容发布统计
- [ ] 付费转化统计
- [ ] 活跃度分析

**技术方案**:
- 可直接使用 NodeBB 自带的 Admin Panel
- 根据需求定制 NodeBB Admin 插件

---

### 📋 第五阶段：测试与优化 (第7周)

#### 5.1 功能测试

- [ ] 单元测试
- [ ] 集成测试
- [ ] 端到端测试
- [ ] 性能测试

#### 5.2 优化

- [ ] 接口性能优化
- [ ] 小程序包体积优化
- [ ] 图片压缩和CDN
- [ ] Redis缓存优化

#### 5.3 上线准备

- [ ] 小程序代码审核
- [ ] 服务器部署
- [ ] 域名备案和SSL证书
- [ ] 微信支付配置
- [ ] 数据备份方案

---

## 三、核心API接口设计

### 3.1 用户相关

```javascript
// 微信登录
POST /api/moti/auth/wechat
{
  "code": "wx_login_code"
}
Response: { uid, token, userInfo }

// 绑定手机号
POST /api/moti/auth/phone
{
  "phone": "13800138000",
  "code": "123456"
}

// 获取用户信息
GET /api/moti/user/profile
Response: { uid, username, avatar, vipExpire, points, ... }

// 获取互动记录
GET /api/moti/user/interactions?type=likes|comments|bookmarks
```

### 3.2 内容相关

```javascript
// 获取帖子列表
GET /api/moti/posts?page=1&sort=newest&topic=xx&date=2025-10
Response: {
  posts: [...],
  pagination: { page, total }
}

// 获取帖子详情
GET /api/moti/post/:pid
Response: { pid, title, content, author, ... }

// 搜索
GET /api/moti/search?q=关键词&page=1

// 创建帖子
POST /api/moti/posts/create
{
  "title": "标题",
  "content": "内容",
  "tags": ["tag1", "tag2"]
}
```

### 3.3 互动相关

```javascript
// 点赞/取消点赞
POST /api/moti/post/:pid/upvote
DELETE /api/moti/post/:pid/upvote

// 收藏/取消收藏
POST /api/moti/post/:pid/bookmark
DELETE /api/moti/post/:pid/bookmark

// 评论
POST /api/moti/post/:pid/comment
{
  "content": "评论内容"
}

// 获取评论列表
GET /api/moti/post/:pid/comments?page=1
```

### 3.4 支付相关

```javascript
// 创建订单
POST /api/moti/orders/create
{
  "planId": "monthly",
  "amount": 29.9
}
Response: { orderId, paymentParams }

// 支付回调
POST /api/moti/payment/callback
// 微信支付回调

// 查询订单
GET /api/moti/orders/:orderId
```

---

## 四、数据库设计扩展

### 4.1 扩展 NodeBB 数据结构

```javascript
// 用户扩展字段
user:{uid} hash
  - wechat_openid
  - phone
  - vip_expire_time
  - points
  - daily_read_count
  - last_read_date

// 帖子扩展字段
topic:{tid} hash
  - view_permission (free/vip)
  - is_featured
  - bookmark_count

// 笔记数据
note:{noteId} hash
  - uid
  - pid
  - content
  - note
  - position
  - timestamp

// 订单数据
order:{orderId} hash
  - uid
  - plan_id
  - amount
  - status
  - payment_no
  - created_at
```

---

## 五、关键技术难点及解决方案

### 5.1 阅读权限控制

**难点**: 未付费用户每日限读1篇

**解决方案**:
```javascript
// NodeBB 中间件
async function checkReadPermission(req, res, next) {
  const { uid } = req.user;
  const { pid } = req.params;

  // 检查是否付费用户
  const vipExpire = await db.getObjectField(`user:${uid}`, 'vip_expire_time');
  if (vipExpire && vipExpire > Date.now()) {
    return next(); // 付费用户直接通过
  }

  // 检查今日阅读次数
  const today = new Date().toDateString();
  const lastRead = await db.getObjectField(`user:${uid}`, 'last_read_date');
  const readCount = await db.getObjectField(`user:${uid}`, 'daily_read_count');

  if (lastRead !== today) {
    // 新的一天，重置计数
    await db.setObject(`user:${uid}`, {
      last_read_date: today,
      daily_read_count: 0
    });
  }

  if (readCount >= 1) {
    return res.status(403).json({ error: 'Daily limit exceeded' });
  }

  // 增加阅读次数
  await db.incrObjectField(`user:${uid}`, 'daily_read_count');
  next();
}
```

### 5.2 文本划线笔记

**难点**: 在小程序中实现文本选择和高亮

**解决方案**:
- 使用 `rich-text` 组件渲染内容
- 监听文本选择事件
- 记录选择的位置偏移量
- 使用 `<span>` 标签包裹高亮文本

### 5.3 性能优化

**难点**: 帖子列表加载慢

**解决方案**:
- Redis 缓存热门帖子列表
- 图片懒加载
- 分页加载（虚拟列表）
- CDN 加速静态资源

---

## 六、开发优先级建议

### 🔴 P0 (必须完成)
1. 用户登录注册
2. 帖子列表和详情
3. 阅读权限控制
4. 基础互动（点赞、评论、收藏）
5. 微信支付

### 🟡 P1 (重要功能)
1. 搜索和筛选
2. 发帖功能
3. 个人中心
4. 管理后台

### 🟢 P2 (增强功能)
1. 划线笔记
2. 积分系统
3. 数据统计
4. 分享功能

---

## 七、环境配置清单

### 7.1 开发环境
- [x] Node.js 23.x
- [x] Redis
- [ ] 微信开发者工具
- [ ] uni-app CLI

### 7.2 生产环境
- [ ] 云服务器（阿里云/腾讯云）
- [ ] 域名和SSL证书
- [ ] 微信小程序账号
- [ ] 微信支付商户号
- [ ] CDN 服务

### 7.3 第三方服务
- [ ] 微信 OAuth
- [ ] 微信支付
- [ ] 短信验证服务
- [ ] 对象存储（图片）

---

## 八、下一步行动

### 立即开始
1. **决定小程序框架**: uni-app 或 微信原生
2. **创建微信小程序账号**
3. **设计数据库扩展方案**
4. **编写 NodeBB 自定义插件骨架**

### 本周目标
- 完成 NodeBB 插件开发环境搭建
- 实现基础的用户登录 API
- 初始化小程序项目

---

## 九、风险评估

| 风险项 | 概率 | 影响 | 应对措施 |
|--------|------|------|----------|
| 微信审核不通过 | 中 | 高 | 提前了解审核规则，准备备用方案 |
| NodeBB 定制难度大 | 中 | 中 | 深入学习 NodeBB 插件开发文档 |
| 支付接口联调困难 | 低 | 高 | 提前申请测试账号，熟悉文档 |
| 性能问题 | 中 | 中 | 做好缓存设计，准备扩容方案 |

---

## 附录：参考资源

- [NodeBB 插件开发文档](https://docs.nodebb.org/development/plugins/)
- [NodeBB API 文档](https://docs.nodebb.org/api/)
- [微信小程序开发文档](https://developers.weixin.qq.com/miniprogram/dev/framework/)
- [uni-app 文档](https://uniapp.dcloud.net.cn/)
- [微信支付接入指南](https://pay.weixin.qq.com/wiki/doc/api/index.html)
