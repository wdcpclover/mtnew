# è«æä¹‹åœ°è¯„è®ºç³»ç»ŸAPIæ–‡æ¡£

## ğŸ“‹ å¼€å‘å®Œæˆæ€»ç»“

**å¼€å‘æ—¶é—´**: 2025å¹´10æœˆ30æ—¥
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**ç‰ˆæœ¬**: v1.0.0

---

## ğŸ¯ åŠŸèƒ½æ¦‚è¿°

è¯„è®ºç³»ç»Ÿæ˜¯è«æä¹‹åœ°å°ç¨‹åºçš„æ ¸å¿ƒäº’åŠ¨åŠŸèƒ½ä¹‹ä¸€ï¼Œæ”¯æŒç”¨æˆ·å¯¹å¸–å­è¿›è¡Œè¯„è®ºã€ç‚¹èµã€æ”¶è—å’Œä¸¾æŠ¥ç­‰æ“ä½œã€‚æœ¬ç³»ç»ŸåŸºäºNodeBBçš„åŸç”Ÿè¯„è®ºæ¶æ„ï¼Œå¹¶è¿›è¡Œäº†é€‚é…å’Œæ‰©å±•ï¼Œæä¾›äº†ç¬¦åˆå°ç¨‹åºä½¿ç”¨çš„RESTful APIã€‚

### æ ¸å¿ƒåŠŸèƒ½

- âœ… å‘è¡¨è¯„è®ºï¼ˆæ”¯æŒåµŒå¥—å›å¤ï¼‰
- âœ… è·å–è¯„è®ºåˆ—è¡¨ï¼ˆåˆ†é¡µï¼‰
- âœ… ç‚¹èµ/å–æ¶ˆç‚¹èµè¯„è®º
- âœ… æ”¶è—/å–æ¶ˆæ”¶è—è¯„è®º
- âœ… åˆ é™¤è¯„è®ºï¼ˆæƒé™æ§åˆ¶ï¼‰
- âœ… ä¸¾æŠ¥è¯„è®º

---

## ğŸ“¡ APIç«¯ç‚¹åˆ—è¡¨

### åŸºç¡€URL
```
http://localhost:4567/api/moti
```

### è¯„è®ºç›¸å…³API

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | è®¤è¯ | çŠ¶æ€ |
|------|------|------|------|------|
| `/post/:pid/comment` | POST | å‘è¡¨è¯„è®º | âœ… éœ€è¦ | âœ… å·²å®Œæˆ |
| `/post/:pid/comments` | GET | è·å–è¯„è®ºåˆ—è¡¨ | âŒ ä¸éœ€è¦ | âœ… å·²å®Œæˆ |
| `/comment/:cid/upvote` | POST | ç‚¹èµè¯„è®º | âœ… éœ€è¦ | âœ… å·²å®Œæˆ |
| `/comment/:cid/upvote` | DELETE | å–æ¶ˆç‚¹èµ | âœ… éœ€è¦ | âœ… å·²å®Œæˆ |
| `/comment/:cid/bookmark` | POST | æ”¶è—è¯„è®º | âœ… éœ€è¦ | âœ… å·²å®Œæˆ |
| `/comment/:cid/bookmark` | DELETE | å–æ¶ˆæ”¶è— | âœ… éœ€è¦ | âœ… å·²å®Œæˆ |
| `/comment/:cid` | DELETE | åˆ é™¤è¯„è®º | âœ… éœ€è¦ | âœ… å·²å®Œæˆ |
| `/comment/:cid/flag` | POST | ä¸¾æŠ¥è¯„è®º | âœ… éœ€è¦ | âœ… å·²å®Œæˆ |

---

## ğŸ”Œ APIè¯¦ç»†è¯´æ˜

### 1. å‘è¡¨è¯„è®º

**ç«¯ç‚¹**: `POST /api/moti/post/:pid/comment`

**æè¿°**: å¯¹æŒ‡å®šå¸–å­å‘è¡¨è¯„è®ºï¼Œæ”¯æŒç›´æ¥è¯„è®ºå’ŒåµŒå¥—å›å¤

**è®¤è¯**: éœ€è¦ç”¨æˆ·ç™»å½•

**è·¯å¾„å‚æ•°**:
- `pid` (number): å¸–å­ID

**è¯·æ±‚ä½“**:
```json
{
  "content": "è¯„è®ºå†…å®¹",
  "toPid": 123  // å¯é€‰ï¼Œå›å¤çš„è¯„è®ºID
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "è¯„è®ºå‘è¡¨æˆåŠŸ",
  "data": {
    "pid": 456,
    "uid": 1,
    "tid": 10,
    "content": "è¯„è®ºå†…å®¹",
    "timestamp": 1761826888329,
    "upvotes": 0,
    "votes": 0,
    "user": {
      "username": "admin",
      "picture": "/path/to/avatar.jpg"
    }
  }
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "è¯„è®ºå†…å®¹ä¸èƒ½ä¸ºç©º"
}
```

---

### 2. è·å–è¯„è®ºåˆ—è¡¨

**ç«¯ç‚¹**: `GET /api/moti/post/:pid/comments`

**æè¿°**: è·å–æŒ‡å®šå¸–å­çš„æ‰€æœ‰è¯„è®ºåˆ—è¡¨

**è®¤è¯**: ä¸éœ€è¦

**è·¯å¾„å‚æ•°**:
- `pid` (number): å¸–å­ID

**æŸ¥è¯¢å‚æ•°**:
- `page` (number): é¡µç ï¼Œé»˜è®¤ä¸º1
- `limit` (number): æ¯é¡µæ•°é‡ï¼Œé»˜è®¤ä¸º20

**è¯·æ±‚ç¤ºä¾‹**:
```
GET /api/moti/post/123/comments?page=1&limit=20
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": {
    "comments": [
      {
        "pid": 456,
        "uid": 1,
        "content": "è¿™æ˜¯ä¸€æ¡è¯„è®º",
        "timestamp": 1761826888329,
        "upvotes": 5,
        "votes": 5,
        "deleted": 0,
        "user": {
          "username": "admin",
          "picture": "/path/to/avatar.jpg"
        }
      }
    ],
    "page": 1,
    "limit": 20,
    "total": 10,
    "pageCount": 1
  }
}
```

---

### 3. ç‚¹èµè¯„è®º

**ç«¯ç‚¹**: `POST /api/moti/comment/:cid/upvote`

**æè¿°**: å¯¹æŒ‡å®šè¯„è®ºè¿›è¡Œç‚¹èµ

**è®¤è¯**: éœ€è¦ç”¨æˆ·ç™»å½•

**è·¯å¾„å‚æ•°**:
- `cid` (number): è¯„è®ºID

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "ç‚¹èµæˆåŠŸ",
  "data": {
    "upvotes": 6,
    "votes": 6
  }
}
```

---

### 4. å–æ¶ˆç‚¹èµè¯„è®º

**ç«¯ç‚¹**: `DELETE /api/moti/comment/:cid/upvote`

**æè¿°**: å–æ¶ˆå¯¹æŒ‡å®šè¯„è®ºçš„ç‚¹èµ

**è®¤è¯**: éœ€è¦ç”¨æˆ·ç™»å½•

**è·¯å¾„å‚æ•°**:
- `cid` (number): è¯„è®ºID

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "å·²å–æ¶ˆç‚¹èµ",
  "data": {
    "upvotes": 5,
    "votes": 5
  }
}
```

---

### 5. æ”¶è—è¯„è®º

**ç«¯ç‚¹**: `POST /api/moti/comment/:cid/bookmark`

**æè¿°**: æ”¶è—æŒ‡å®šè¯„è®º

**è®¤è¯**: éœ€è¦ç”¨æˆ·ç™»å½•

**è·¯å¾„å‚æ•°**:
- `cid` (number): è¯„è®ºID

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "æ”¶è—æˆåŠŸ"
}
```

---

### 6. å–æ¶ˆæ”¶è—è¯„è®º

**ç«¯ç‚¹**: `DELETE /api/moti/comment/:cid/bookmark`

**æè¿°**: å–æ¶ˆæ”¶è—æŒ‡å®šè¯„è®º

**è®¤è¯**: éœ€è¦ç”¨æˆ·ç™»å½•

**è·¯å¾„å‚æ•°**:
- `cid` (number): è¯„è®ºID

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "å·²å–æ¶ˆæ”¶è—"
}
```

---

### 7. åˆ é™¤è¯„è®º

**ç«¯ç‚¹**: `DELETE /api/moti/comment/:cid`

**æè¿°**: åˆ é™¤æŒ‡å®šè¯„è®ºï¼ˆè½¯åˆ é™¤ï¼‰

**è®¤è¯**: éœ€è¦ç”¨æˆ·ç™»å½•

**æƒé™**:
- è¯„è®ºä½œè€…å¯ä»¥åˆ é™¤è‡ªå·±çš„è¯„è®º
- ç®¡ç†å‘˜å¯ä»¥åˆ é™¤ä»»ä½•è¯„è®º
- ç‰ˆä¸»å¯ä»¥åˆ é™¤ä»»ä½•è¯„è®º

**è·¯å¾„å‚æ•°**:
- `cid` (number): è¯„è®ºID

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "è¯„è®ºå·²åˆ é™¤"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "æ— æƒé™åˆ é™¤æ­¤è¯„è®º"
}
```

---

### 8. ä¸¾æŠ¥è¯„è®º

**ç«¯ç‚¹**: `POST /api/moti/comment/:cid/flag`

**æè¿°**: ä¸¾æŠ¥ä¸å½“è¯„è®º

**è®¤è¯**: éœ€è¦ç”¨æˆ·ç™»å½•

**è·¯å¾„å‚æ•°**:
- `cid` (number): è¯„è®ºID

**è¯·æ±‚ä½“**:
```json
{
  "reason": "ä¸¾æŠ¥åŸå› è¯´æ˜"
}
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "message": "ä¸¾æŠ¥å·²æäº¤"
}
```

**é”™è¯¯å“åº”**:
```json
{
  "error": "è¯·å¡«å†™ä¸¾æŠ¥åŸå› "
}
```

---

## ğŸ” è®¤è¯è¯´æ˜

æ‰€æœ‰éœ€è¦è®¤è¯çš„APIéƒ½ä½¿ç”¨NodeBBçš„Cookie Sessionæœºåˆ¶ã€‚åœ¨å‘é€è¯·æ±‚æ—¶éœ€è¦ï¼š

1. **æµè§ˆå™¨ç¯å¢ƒ**: ä½¿ç”¨ `credentials: 'include'` æºå¸¦cookie
2. **å°ç¨‹åºç¯å¢ƒ**: éœ€è¦åœ¨è¯·æ±‚å¤´ä¸­æºå¸¦session token

### å°ç¨‹åºè¯·æ±‚ç¤ºä¾‹

```javascript
wx.request({
  url: 'http://localhost:4567/api/moti/post/123/comment',
  method: 'POST',
  header: {
    'Content-Type': 'application/json',
    'Cookie': 'express.sid=xxxx' // ç™»å½•åè·å¾—çš„session
  },
  data: {
    content: 'è¿™æ˜¯ä¸€æ¡è¯„è®º'
  },
  success: function(res) {
    console.log(res.data);
  }
});
```

---

## ğŸ“Š æ•°æ®ç»“æ„è¯´æ˜

### è¯„è®ºå¯¹è±¡ (Comment)

```typescript
interface Comment {
  pid: number;              // è¯„è®ºIDï¼ˆåœ¨NodeBBä¸­è¯„è®ºä¹Ÿæ˜¯postï¼‰
  uid: number;              // ç”¨æˆ·ID
  tid: number;              // ä¸»é¢˜ID
  content: string;          // è¯„è®ºå†…å®¹ï¼ˆHTMLï¼‰
  timestamp: number;        // å‘è¡¨æ—¶é—´æˆ³
  upvotes: number;          // ç‚¹èµæ•°
  downvotes: number;        // è¸©æ•°ï¼ˆä¸€èˆ¬ä¸ä½¿ç”¨ï¼‰
  votes: number;            // å‡€æŠ•ç¥¨æ•° (upvotes - downvotes)
  bookmarks: number;        // æ”¶è—æ•°
  deleted: 0 | 1;           // åˆ é™¤çŠ¶æ€ï¼ˆ0æœªåˆ é™¤ï¼Œ1å·²åˆ é™¤ï¼‰
  toPid?: number;           // çˆ¶è¯„è®ºIDï¼ˆåµŒå¥—å›å¤æ—¶ï¼‰
  user: {
    uid: number;
    username: string;
    userslug: string;
    picture: string;
  };
}
```

---

## ğŸ§ª æµ‹è¯•

### æµ‹è¯•é¡µé¢

æˆ‘ä»¬æä¾›äº†ä¸€ä¸ªHTMLæµ‹è¯•é¡µé¢ï¼š`test-comment-api.html`

**ä½¿ç”¨æ–¹æ³•**:

1. ç¡®ä¿NodeBBæœåŠ¡å™¨æ­£åœ¨è¿è¡Œ
2. åœ¨æµè§ˆå™¨ä¸­è®¿é—® `http://localhost:4567` å¹¶ä½¿ç”¨adminè´¦æˆ·ç™»å½•
3. åˆ›å»ºä¸€ä¸ªæµ‹è¯•å¸–å­
4. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `test-comment-api.html`
5. æŒ‰ç…§é¡µé¢æç¤ºè¿›è¡Œå„é¡¹åŠŸèƒ½æµ‹è¯•

### curlæµ‹è¯•ç¤ºä¾‹

```bash
# 1. è·å–å¸–å­åˆ—è¡¨
curl "http://localhost:4567/api/moti/posts?page=1"

# 2. è·å–è¯„è®ºåˆ—è¡¨
curl "http://localhost:4567/api/moti/post/123/comments?page=1&limit=20"

# 3. å‘è¡¨è¯„è®ºï¼ˆéœ€è¦ç™»å½•åçš„cookieï¼‰
curl -X POST "http://localhost:4567/api/moti/post/123/comment" \
  -H "Content-Type: application/json" \
  -b "express.sid=YOUR_SESSION_COOKIE" \
  -d '{"content": "è¿™æ˜¯ä¸€æ¡æµ‹è¯•è¯„è®º"}'

# 4. ç‚¹èµè¯„è®º
curl -X POST "http://localhost:4567/api/moti/comment/456/upvote" \
  -b "express.sid=YOUR_SESSION_COOKIE"

# 5. åˆ é™¤è¯„è®º
curl -X DELETE "http://localhost:4567/api/moti/comment/456" \
  -b "express.sid=YOUR_SESSION_COOKIE"
```

---

## ğŸš€ åç»­å¼€å‘å»ºè®®

### å·²å®ŒæˆåŠŸèƒ½ (100%)
- âœ… å‘è¡¨è¯„è®º
- âœ… è·å–è¯„è®ºåˆ—è¡¨
- âœ… ç‚¹èµ/å–æ¶ˆç‚¹èµ
- âœ… æ”¶è—/å–æ¶ˆæ”¶è—
- âœ… åˆ é™¤è¯„è®º
- âœ… ä¸¾æŠ¥è¯„è®º
- âœ… æƒé™æ§åˆ¶

### å¯é€‰å¢å¼ºåŠŸèƒ½

1. **è¯„è®ºç¼–è¾‘åŠŸèƒ½**
   - API: `PUT /api/moti/comment/:cid`
   - ä»…å…è®¸ä½œè€…åœ¨å‘è¡¨åä¸€å®šæ—¶é—´å†…ç¼–è¾‘

2. **è¯„è®ºç½®é¡¶åŠŸèƒ½**
   - API: `POST /api/moti/comment/:cid/pin`
   - ä»…ç®¡ç†å‘˜å¯æ“ä½œ

3. **è¯„è®ºæ’åº**
   - æ”¯æŒæŒ‰æ—¶é—´ã€çƒ­åº¦ã€ç‚¹èµæ•°æ’åº
   - å‚æ•°: `?sort=newest|popular|votes`

4. **è·å–ç”¨æˆ·è¯„è®ºå†å²**
   - API: `GET /api/moti/user/:uid/comments`

5. **è¯„è®ºæœç´¢**
   - API: `GET /api/moti/search/comments?q=å…³é”®è¯`

6. **è¯„è®ºé€šçŸ¥**
   - å½“æœ‰äººå›å¤è¯„è®ºæ—¶æ¨é€é€šçŸ¥
   - WebSocketå®æ—¶é€šçŸ¥

7. **è¡¨æƒ…å›åº” (Reactions)**
   - ç±»ä¼¼å¾®ä¿¡çš„è¡¨æƒ…å›åº”åŠŸèƒ½
   - API: `POST /api/moti/comment/:cid/react`

---

## ğŸ“ ä»£ç ä½ç½®

**æ’ä»¶ä¸»æ–‡ä»¶**: `/Users/changpengcheng/MT/nodebb/node_modules/nodebb-plugin-moti-api/library.js`

**è¯„è®ºç›¸å…³å‡½æ•°** (ä»line 602å¼€å§‹):
- `createComment()` - å‘è¡¨è¯„è®º
- `getComments()` - è·å–è¯„è®ºåˆ—è¡¨
- `upvoteComment()` - ç‚¹èµè¯„è®º
- `unvoteComment()` - å–æ¶ˆç‚¹èµ
- `bookmarkComment()` - æ”¶è—è¯„è®º
- `unbookmarkComment()` - å–æ¶ˆæ”¶è—
- `deleteComment()` - åˆ é™¤è¯„è®º
- `flagComment()` - ä¸¾æŠ¥è¯„è®º

---

## ğŸ”§ æŠ€æœ¯æ¶æ„

### NodeBBè¯„è®ºç³»ç»ŸåŸç†

åœ¨NodeBBä¸­ï¼Œè¯„è®ºï¼ˆReplyï¼‰å®é™…ä¸Šä¹Ÿæ˜¯Postå¯¹è±¡ï¼Œä¸ä¸»è´´å…±äº«ç›¸åŒçš„æ•°æ®ç»“æ„ï¼Œé€šè¿‡ä»¥ä¸‹æ–¹å¼åŒºåˆ†ï¼š

1. **ä¸»é¢˜å…³è”**: æ‰€æœ‰è¯„è®ºé€šè¿‡ `tid` (Topic ID) å…³è”åˆ°åŒä¸€ä¸ªä¸»é¢˜
2. **çˆ¶å­å…³ç³»**: é€šè¿‡ `toPid` å­—æ®µå®ç°åµŒå¥—å›å¤
3. **æ—¶é—´æ’åº**: ä½¿ç”¨SortedSet `tid:{tid}:posts` å­˜å‚¨è¯„è®ºåˆ—è¡¨

### Redisæ•°æ®ç»“æ„

```
# è¯„è®ºå¯¹è±¡
post:{pid} hash
  - pid, uid, tid, content, timestamp, upvotes, votes, etc.

# ä¸»é¢˜è¯„è®ºç´¢å¼•
tid:{tid}:posts sorted set
  - score: timestamp
  - member: pid

# æŠ•ç¥¨è®°å½•
pid:{pid}:upvote set
  - members: uidåˆ—è¡¨

uid:{uid}:upvote sorted set
  - score: timestamp
  - member: pid
```

---

## ğŸ’¡ æ³¨æ„äº‹é¡¹

1. **è¯„è®ºæƒé™**: ç›®å‰æ‰€æœ‰ç™»å½•ç”¨æˆ·éƒ½å¯ä»¥è¯„è®ºï¼Œå¦‚éœ€é™åˆ¶ï¼ˆå¦‚ä»…VIPå¯è¯„è®ºï¼‰ï¼Œéœ€è¦åœ¨`createComment`å‡½æ•°ä¸­æ·»åŠ æƒé™æ£€æŸ¥ã€‚

2. **å†…å®¹å®¡æ ¸**: è¯„è®ºå†…å®¹æœªè¿›è¡Œæ•æ„Ÿè¯è¿‡æ»¤ï¼Œå»ºè®®é›†æˆç¬¬ä¸‰æ–¹å®¡æ ¸æœåŠ¡ã€‚

3. **é¢‘ç‡é™åˆ¶**: æœªå®ç°è¯„è®ºé¢‘ç‡é™åˆ¶ï¼Œå»ºè®®æ·»åŠ é˜²åˆ·æœºåˆ¶ã€‚

4. **åµŒå¥—æ·±åº¦**: NodeBBæ”¯æŒæ— é™å±‚çº§åµŒå¥—å›å¤ï¼Œä½†ä¸ºäº†UIç¾è§‚ï¼Œå»ºè®®å°ç¨‹åºç«¯åªæ˜¾ç¤ºä¸¤çº§ã€‚

5. **åˆ é™¤æ–¹å¼**: å½“å‰ä½¿ç”¨è½¯åˆ é™¤ï¼ˆdeleted=1ï¼‰ï¼Œå¦‚éœ€æ°¸ä¹…åˆ é™¤ï¼Œå¯ä½¿ç”¨ `posts.purge(pid)`ã€‚

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·æäº¤issueæˆ–è”ç³»å¼€å‘å›¢é˜Ÿã€‚

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0.0
**æœ€åæ›´æ–°**: 2025å¹´10æœˆ30æ—¥
**å¼€å‘çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶å¯ç”¨äºç”Ÿäº§ç¯å¢ƒ
