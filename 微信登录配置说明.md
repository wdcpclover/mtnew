# 微信登录配置与用户信息存储说明

## 一、微信登录配置

### 1. 配置 NodeBB 后端

已在 `/nodebb/config.json` 中添加了微信配置：

```json
{
  "wechat:appId": "wx0039e0ebf533a6d6",
  "wechat:appSecret": "YOUR_WECHAT_APP_SECRET_HERE"
}
```

**⚠️ 重要：请将 `YOUR_WECHAT_APP_SECRET_HERE` 替换为你的真实微信小程序 AppSecret**

### 2. 获取微信小程序密钥

1. 登录[微信公众平台](https://mp.weixin.qq.com/)
2. 进入你的小程序管理后台
3. 开发 → 开发管理 → 开发设置
4. 找到 **AppSecret（小程序密钥）**
5. 复制密钥并替换到 `config.json` 中

### 3. 重启 NodeBB 服务

配置修改后需要重启服务：

```bash
cd nodebb
./nodebb stop
./nodebb start
```

---

## 二、本地用户信息存储

### 存储的用户信息字段

登录成功后，小程序会自动存储以下完整用户信息：

```javascript
{
  // 基本信息
  uid: 123,                    // 用户ID
  username: "wx_abc123",       // 用户名
  nickname: "张三",            // 昵称
  email: "user@example.com",   // 邮箱

  // 头像
  avatar: "https://...",       // 头像URL

  // VIP 信息
  isVIP: true,                 // 是否VIP
  vipExpireTime: 1672531200000,// VIP过期时间戳

  // 积分信息
  points: 100,                 // 积分
  reputation: 50,              // 声望

  // 统计信息
  postcount: 10,               // 发帖数
  topiccount: 5,               // 主题数
  readCount: 220,              // 已读文章数
  dailyReadCount: 2,           // 今日已读数
  readingTime: 3600,           // 阅读时长（秒）
  consecutiveDays: 30,         // 连续签到天数

  // 联系方式
  phone: "138****1234",        // 手机号

  // 微信信息
  openid: "oABC123...",        // 微信OpenID
  unionid: "uXYZ789...",       // 微信UnionID

  // 时间戳
  joindate: 1640995200000,     // 注册时间
  lastonline: 1672531200000,   // 最后在线时间

  // 状态
  status: "online",            // 在线状态
  banned: false                // 是否被封禁
}
```

### 获取存储的用户信息

#### 方法 1：通过 API 模块

```javascript
const api = require('../../utils/api')

Page({
  onLoad() {
    // 获取完整用户信息
    const userInfo = api.getUser()

    console.log('用户ID:', userInfo.uid)
    console.log('昵称:', userInfo.nickname)
    console.log('是否VIP:', userInfo.isVIP)
    console.log('积分:', userInfo.points)
    console.log('已读文章:', userInfo.readCount)

    this.setData({ userInfo })
  }
})
```

#### 方法 2：通过 App 全局数据

```javascript
const app = getApp()

Page({
  onLoad() {
    // 检查是否登录
    if (app.globalData.isLoggedIn) {
      const userInfo = app.globalData.userInfo

      this.setData({
        userName: userInfo.nickname,
        userAvatar: userInfo.avatar,
        isVIP: userInfo.isVIP
      })
    }
  }
})
```

#### 方法 3：直接从存储读取

```javascript
Page({
  onLoad() {
    const userInfo = wx.getStorageSync('moti_user')

    if (userInfo) {
      console.log('用户信息:', userInfo)
    }
  }
})
```

---

## 三、用户信息更新机制

### 1. 登录时自动获取

```javascript
// 微信登录成功后，自动获取并存储完整用户信息
async onLoginSuccess(result) {
  // 保存 token
  api.setToken(result.token)

  // 获取完整用户信息
  const profile = await api.getUserProfile()
  const fullUserInfo = { ...result.user, ...profile }

  // 存储到本地
  api.setUser(fullUserInfo)
}
```

### 2. 启动时自动验证

```javascript
// 小程序启动时，自动验证 token 并更新用户信息
onLaunch() {
  const token = api.getToken()
  const userInfo = api.getUser()

  if (token && userInfo) {
    // 验证 token 并刷新用户信息
    this.validateToken()
  }
}
```

### 3. 手动刷新用户信息

```javascript
// 在任何页面手动刷新用户信息
async refreshUserInfo() {
  const api = require('../../utils/api')

  try {
    const profile = await api.getUserProfile()
    api.setUser(profile)

    this.setData({
      userInfo: profile
    })

    wx.showToast({ title: '信息已更新', icon: 'success' })
  } catch (err) {
    wx.showToast({ title: '更新失败', icon: 'none' })
  }
}
```

---

## 四、常见使用场景

### 场景 1：显示用户头像和昵称

```javascript
const api = require('../../utils/api')

Page({
  data: {
    userAvatar: '',
    userName: ''
  },

  onShow() {
    const userInfo = api.getUser()
    if (userInfo) {
      this.setData({
        userAvatar: userInfo.avatar,
        userName: userInfo.nickname || userInfo.username
      })
    }
  }
})
```

### 场景 2：检查 VIP 权限

```javascript
checkVIPAccess() {
  const api = require('../../utils/api')
  const userInfo = api.getUser()

  if (!userInfo) {
    wx.showToast({ title: '请先登录', icon: 'none' })
    return false
  }

  if (!userInfo.isVIP) {
    wx.showModal({
      title: '开通 VIP',
      content: '此功能需要 VIP 权限',
      confirmText: '立即开通',
      success: (res) => {
        if (res.confirm) {
          wx.navigateTo({ url: '/pages/vip/vip' })
        }
      }
    })
    return false
  }

  // VIP 已过期检查
  if (userInfo.vipExpireTime < Date.now()) {
    wx.showModal({
      title: 'VIP 已过期',
      content: '您的 VIP 已过期，请续费',
      confirmText: '立即续费',
      success: (res) => {
        if (res.confirm) {
          wx.navigateTo({ url: '/pages/vip/vip' })
        }
      }
    })
    return false
  }

  return true
}
```

### 场景 3：显示阅读统计

```javascript
const api = require('../../utils/api')

Page({
  data: {
    readArticles: 0,
    totalArticles: 3000,
    progressPercent: 0,
    readingHours: 0,
    readingDays: 0
  },

  onLoad() {
    const userInfo = api.getUser()

    if (userInfo) {
      this.setData({
        readArticles: userInfo.readCount || 0,
        totalArticles: 3000,
        progressPercent: ((userInfo.readCount / 3000) * 100).toFixed(1),
        readingHours: (userInfo.readingTime / 3600).toFixed(1),
        readingDays: userInfo.consecutiveDays || 0
      })
    }
  }
})
```

### 场景 4：显示积分和等级

```javascript
getUserLevel() {
  const api = require('../../utils/api')
  const userInfo = api.getUser()

  if (!userInfo) return { level: 0, title: '游客' }

  const points = userInfo.points || 0

  if (points >= 1000) return { level: 5, title: '大师' }
  if (points >= 500) return { level: 4, title: '专家' }
  if (points >= 200) return { level: 3, title: '高手' }
  if (points >= 50) return { level: 2, title: '学徒' }
  return { level: 1, title: '新手' }
}
```

---

## 五、测试登录流程

### 1. 准备工作

- ✅ 确保 `config.json` 中已填写正确的 `wechat:appSecret`
- ✅ 重启 NodeBB 服务
- ✅ 确保小程序 AppID 与后端配置一致

### 2. 测试步骤

1. 打开小程序
2. 进入登录页面
3. 点击"微信登录"
4. 授权手机号（可选）
5. 完善用户信息（新用户）
6. 登录成功后，检查控制台输出的用户信息

### 3. 验证存储

在开发者工具中查看 Storage：

```
Storage → moti_token  → (查看 token)
Storage → moti_user   → (查看完整用户信息)
```

### 4. 调试命令

在控制台执行：

```javascript
// 查看存储的用户信息
const api = require('./utils/api')
console.log(api.getUser())

// 查看全局用户信息
const app = getApp()
console.log(app.globalData.userInfo)
```

---

## 六、故障排查

### 问题 1：登录报错 "wechat config missing"

**解决方法：**
1. 检查 `/nodebb/config.json` 是否包含 `wechat:appId` 和 `wechat:appSecret`
2. 确认 AppSecret 已替换为真实值
3. 重启 NodeBB 服务

### 问题 2：用户信息为空

**解决方法：**
1. 检查登录是否成功
2. 查看控制台是否有错误日志
3. 使用 `api.getUser()` 检查本地存储

### 问题 3：Token 失效

**解决方法：**
1. Token 有效期为 7 天
2. 过期后会自动清除登录状态
3. 用户需要重新登录

---

## 七、安全建议

1. **不要在前端代码中硬编码 AppSecret**
2. **定期更新 Token**
3. **敏感操作需要二次验证**
4. **不要将完整手机号存储在前端**
5. **定期清理过期的本地数据**

---

## 八、API 参考

### 用户信息相关 API

| API 方法 | 说明 | 返回值 |
|---------|------|-------|
| `api.getUser()` | 获取本地存储的用户信息 | Object |
| `api.setUser(user)` | 存储用户信息到本地 | void |
| `api.clearUser()` | 清除本地用户信息 | void |
| `api.getUserProfile()` | 从服务器获取用户信息 | Promise |
| `api.updateUserProfile(data)` | 更新用户信息 | Promise |
| `api.getUserStats()` | 获取用户统计数据 | Promise |

---

**更新时间：** 2026-01-03
**维护者：** Claude Code
