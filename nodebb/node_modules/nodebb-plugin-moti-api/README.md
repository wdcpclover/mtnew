# NodeBB 莫提之地 API 插件

为微信小程序提供的专用 REST API。

## 配置

在 NodeBB 的 `config.json` 中添加配置：

```json
{
  "wechat": {
    "appId": "小程序AppID",
    "appSecret": "小程序AppSecret",
    "mchId": "微信支付商户号",
    "apiKey": "微信支付API密钥",
    "apiV3Key": "微信支付APIv3密钥",
    "serialNo": "商户证书序列号",
    "privateKey": "商户私钥",
    "notifyUrl": "https://你的域名/api/moti/payment/callback"
  }
}
```

## API 接口

### 认证

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/moti/auth/wechat` | POST | 微信登录 |
| `/api/moti/auth/refresh` | POST | 刷新 Token |
| `/api/moti/auth/logout` | POST | 退出登录 |
| `/api/moti/auth/bindPhone` | POST | 绑定手机号 |

### 用户

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/moti/user/profile` | GET/PUT | 获取/更新用户资料 |
| `/api/moti/user/bookmarks` | GET | 我的收藏列表 |
| `/api/moti/user/upvotes` | GET | 我的点赞记录 |
| `/api/moti/user/posts` | GET | 我发表的评论 |
| `/api/moti/user/topics` | GET | 我发表的帖子 |
| `/api/moti/user/received-upvotes` | GET | 被点赞记录 |
| `/api/moti/user/received-replies` | GET | 被评论记录 |
| `/api/moti/user/points` | GET | 积分信息 |
| `/api/moti/user/stats` | GET | 互动统计概览 |
| `/api/moti/user/reports` | GET | 我的举报记录 |

### 内容浏览

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/moti/posts` | GET | 帖子列表 |
| `/api/moti/post/:pid` | GET | 帖子详情 |
| `/api/moti/post/:pid/comments` | GET | 评论列表 |
| `/api/moti/search` | GET | 搜索 (q, cid, tags, sort) |
| `/api/moti/categories` | GET | 分类列表 |
| `/api/moti/category/:cid/topics` | GET | 分类下帖子 |
| `/api/moti/tags` | GET | 标签列表 |
| `/api/moti/tag/:tag/topics` | GET | 标签下帖子 |
| `/api/moti/unread` | GET | 未读帖子列表 |
| `/api/moti/topics/read` | POST | 标记已读 |

### 发帖

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/moti/topic/create` | POST | 发布帖子 (需VIP) |

### 互动

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/moti/post/:pid/upvote` | POST/DELETE | 点赞/取消点赞 |
| `/api/moti/post/:pid/bookmark` | POST/DELETE | 收藏/取消收藏 |
| `/api/moti/post/:pid/comment` | POST | 发表评论 |
| `/api/moti/post/:pid/vote` | POST | 投票 (delta: 1/-1/0) |
| `/api/moti/topic/:tid/vote` | POST | 对帖子投票 |
| `/api/moti/report` | POST | 举报内容 |

### 划线笔记

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/moti/notes` | GET | 获取我的笔记列表 |
| `/api/moti/notes` | POST | 创建笔记 (支持 visibility: public/private) |
| `/api/moti/notes/:noteId` | PUT | 更新笔记 (note, color, visibility) |
| `/api/moti/notes/:noteId` | DELETE | 删除笔记 |
| `/api/moti/notes/:noteId/like` | POST | 点赞划线 |
| `/api/moti/notes/:noteId/like` | DELETE | 取消点赞划线 |
| `/api/moti/post/:pid/notes/mine` | GET | 我在帖子的笔记 |
| `/api/moti/post/:pid/notes/public` | GET | 帖子的公开划线 |
| `/api/moti/post/:pid/highlights` | GET | 帖子的聚合划线位置 (热门) |
| `/api/moti/post/:pid/highlight/:start/:end` | GET | 某位置的所有划线 |

### 支付

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/moti/products` | GET | VIP商品列表 |
| `/api/moti/vip/status` | GET | VIP状态 |
| `/api/moti/order/create` | POST | 创建订单 |
| `/api/moti/order/:orderNo` | GET | 查询订单 |
| `/api/moti/orders` | GET | 订单列表 |
| `/api/moti/payments` | GET | 付费记录 |
| `/api/moti/payment/callback` | POST | 支付回调 (微信调用) |

## 小程序端使用示例

```javascript
// 1. 登录
const loginRes = await wx.login()
const res = await wx.request({
  url: 'https://域名/api/moti/auth/wechat',
  method: 'POST',
  data: { code: loginRes.code, userInfo: { nickName: '昵称', avatarUrl: 'URL' } }
})
wx.setStorageSync('token', res.data.data.token)

// 2. 请求封装
const request = (url, options = {}) => wx.request({
  url: 'https://域名' + url,
  header: { 'Authorization': 'Bearer ' + wx.getStorageSync('token') },
  ...options
})

// 3. 购买VIP
const orderRes = await request('/api/moti/order/create', {
  method: 'POST',
  data: { productId: 'vip_month' }
})
wx.requestPayment(orderRes.data.data.payParams)

// 4. 发帖 (需VIP)
await request('/api/moti/topic/create', {
  method: 'POST',
  data: { title: '标题', content: '内容', cid: 1, tags: ['标签1'] }
})

// 5. 投票
await request('/api/moti/topic/1/vote', {
  method: 'POST',
  data: { delta: 1 } // 1=赞, -1=踩, 0=取消
})

// 6. 举报
await request('/api/moti/report', {
  method: 'POST',
  data: { type: 'post', id: 123, reason: '违规内容' }
})
```

## 划线笔记使用示例

```javascript
// 1. 创建公开划线
await request('/api/moti/notes', {
  method: 'POST',
  data: {
    pid: 1,                    // 帖子ID
    content: '被划线的原文',    // 划线内容
    note: '我的批注',          // 笔记（可选）
    startOffset: 0,            // 起始位置
    endOffset: 50,             // 结束位置
    color: '#ffeb3b',          // 颜色（可选）
    visibility: 'public'       // 'public' 公开 / 'private' 私有
  }
})

// 2. 获取帖子的公开划线
const publicNotes = await request('/api/moti/post/1/notes/public')
// 返回: { notes: [{ noteId, uid, content, note, likeCount, user, liked, ... }] }

// 3. 获取帖子的热门划线位置
const highlights = await request('/api/moti/post/1/highlights')
// 返回: { highlights: [{ startOffset, endOffset, count, preview, noteIds }] }

// 4. 获取某位置的所有划线（多人划同一段话）
const positionNotes = await request('/api/moti/post/1/highlight/0/50')
// 返回: { notes: [{ noteId, user, note, liked, ... }] }

// 5. 点赞划线
await request('/api/moti/notes/xxx-note-id/like', { method: 'POST' })

// 6. 修改划线为公开
await request('/api/moti/notes/xxx-note-id', {
  method: 'PUT',
  data: { visibility: 'public' }
})
```

## 版本

- v4.0.0 - 公开划线功能：可见性控制、聚合展示、点赞互动
- v3.0.0 - 添加微信支付、VIP系统、发帖、投票、举报功能
- v2.0.0 - 添加搜索、分类、标签、已读状态、用户互动记录
- v1.0.0 - 基础功能：微信登录、帖子、评论、点赞、收藏、划线笔记
