/* global $, socket, app, ajaxify */

(function () {
  'use strict';

  const MotiHighlight = {
    currentColor: '#ffeb3b',
    highlights: [],
    currentSelection: null,

    init: function () {
      console.log('[Moti] åˆ’çº¿ç¬”è®°åŠŸèƒ½å·²åŠ è½½');

      // åªåœ¨å¸–å­é¡µé¢å¯ç”¨
      if (ajaxify.data.template && (ajaxify.data.template.topic || ajaxify.data.template.post)) {
        this.addFixedButton();
        this.addNotePanel();
        this.bindEvents();
        this.loadNotes();
        this.enhanceSelectionTooltip();
      }
    },

    addFixedButton: function () {
      // å›ºå®šçš„ç¬”è®°æŒ‰é’® - æ”¾åœ¨å³ä¸‹è§’
      const fixedButton = `
        <div id="moti-fixed-buttons" style="
          position: fixed;
          bottom: 20px;
          right: 20px;
          z-index: 9999;
          display: flex;
          flex-direction: column;
          gap: 10px;
        ">
          <button id="moti-show-notes-btn" style="
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            position: relative;
            transition: all 0.3s;
          " onmouseover="this.style.transform='scale(1.1) rotate(5deg)'; this.style.boxShadow='0 6px 20px rgba(0,0,0,0.4)'" onmouseout="this.style.transform='scale(1) rotate(0deg)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.3)'">
            ğŸ“‹
            <span id="moti-notes-count" style="
              position: absolute;
              top: -5px;
              right: -5px;
              background: #ff5722;
              color: white;
              border-radius: 12px;
              padding: 3px 7px;
              font-size: 11px;
              font-weight: bold;
              min-width: 20px;
              display: none;
              box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            ">0</span>
          </button>
        </div>
      `;

      $('body').append(fixedButton);
    },

    enhanceSelectionTooltip: function () {
      const self = this;

      // ç›‘å¬ NodeBB åŸç”Ÿçš„é€‰æ‹©å·¥å…·æç¤ºæ˜¾ç¤ºäº‹ä»¶
      // ä½¿ç”¨ MutationObserver ç›‘å¬å·¥å…·æç¤ºçš„å‡ºç°
      const observer = new MutationObserver(function (mutations) {
        mutations.forEach(function (mutation) {
          mutation.addedNodes.forEach(function (node) {
            if (node.nodeType === 1 && $(node).is('[component="selection/tooltip"]')) {
              self.injectHighlightControls($(node));
            }
          });
        });
      });

      // å¼€å§‹è§‚å¯Ÿ body çš„å­å…ƒç´ å˜åŒ–
      observer.observe(document.body, {
        childList: true,
        subtree: true
      });

      // å¦‚æœå·¥å…·æç¤ºå·²ç»å­˜åœ¨ï¼Œç«‹å³æ³¨å…¥
      const existingTooltip = $('[component="selection/tooltip"]');
      if (existingTooltip.length) {
        self.injectHighlightControls(existingTooltip);
      }
    },

    injectHighlightControls: function ($tooltip) {
      // é¿å…é‡å¤æ³¨å…¥
      if ($tooltip.find('.moti-highlight-controls').length > 0) {
        return;
      }

      const highlightControls = `
        <div class="moti-highlight-controls" style="display: inline-flex; gap: 6px; align-items: center; margin-left: 8px; border-left: 1px solid rgba(0,0,0,0.1); padding-left: 8px;">
          <button class="btn btn-sm btn-success moti-highlight-btn" style="display: inline-flex; align-items: center; gap: 4px;">
            <span>âœ¨</span>
            <span>é«˜äº®</span>
          </button>
          <div class="moti-color-picker" style="display: inline-flex; gap: 4px;">
            <div class="moti-color-option active" data-color="#ffeb3b" style="width: 20px; height: 20px; background: #ffeb3b; border-radius: 50%; cursor: pointer; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);" title="é»„è‰²"></div>
            <div class="moti-color-option" data-color="#4caf50" style="width: 20px; height: 20px; background: #4caf50; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);" title="ç»¿è‰²"></div>
            <div class="moti-color-option" data-color="#ff5722" style="width: 20px; height: 20px; background: #ff5722; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);" title="çº¢è‰²"></div>
            <div class="moti-color-option" data-color="#2196f3" style="width: 20px; height: 20px; background: #2196f3; border-radius: 50%; cursor: pointer; border: 2px solid transparent; box-shadow: 0 0 0 1px rgba(0,0,0,0.1);" title="è“è‰²"></div>
          </div>
        </div>
      `;

      $tooltip.append(highlightControls);
    },

    addNotePanel: function () {
      const panel = `
        <div id="moti-overlay" style="
          position: fixed;
          top: 0;
          left: 0;
          right: 0;
          bottom: 0;
          background: rgba(0,0,0,0.5);
          z-index: 10000;
          display: none;
        "></div>

        <div id="moti-note-panel" style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.3);
          z-index: 10001;
          display: none;
          min-width: 400px;
          max-width: 90%;
        ">
          <h3 style="margin: 0 0 15px 0; color: #667eea;">æ·»åŠ ç¬”è®°</h3>
          <div id="moti-selected-text" style="
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            font-size: 14px;
            color: #666;
          "></div>
          <textarea id="moti-note-input" placeholder="åœ¨è¿™é‡Œå†™ä¸‹ä½ çš„æƒ³æ³•å’Œç¬”è®°..." style="
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 14px;
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
          "></textarea>
          <div style="display: flex; gap: 10px; margin-top: 15px; justify-content: flex-end;">
            <button id="moti-cancel-btn" style="
              padding: 10px 20px;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              background: #6c757d;
              color: white;
            ">å–æ¶ˆ</button>
            <button id="moti-save-note-btn" style="
              padding: 10px 20px;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              background: #667eea;
              color: white;
            ">ä¿å­˜ç¬”è®°</button>
          </div>
        </div>

        <div id="moti-notes-list" style="
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          background: white;
          padding: 30px;
          border-radius: 12px;
          box-shadow: 0 10px 40px rgba(0,0,0,0.3);
          z-index: 10001;
          display: none;
          width: 600px;
          max-width: 90%;
          max-height: 80vh;
          overflow-y: auto;
        ">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h3 style="margin: 0; color: #667eea;">æˆ‘çš„ç¬”è®°</h3>
            <button id="moti-close-notes-btn" style="
              padding: 5px 15px;
              border: none;
              border-radius: 6px;
              cursor: pointer;
              background: #6c757d;
              color: white;
            ">å…³é—­</button>
          </div>
          <div id="moti-notes-container"></div>
        </div>
      `;

      $('body').append(panel);
    },

    bindEvents: function () {
      const self = this;

      // é¢œè‰²é€‰æ‹© - ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬åŠ¨æ€æ³¨å…¥çš„é¢œè‰²é€‰æ‹©å™¨
      $(document).on('click', '.moti-color-option', function (e) {
        e.stopPropagation();
        // æ›´æ–°æ‰€æœ‰é¢œè‰²é€‰é¡¹çš„è¾¹æ¡†
        $('.moti-color-option').css('border', '2px solid transparent');
        $(this).css('border', '2px solid #fff');
        // æ›´æ–°æ´»åŠ¨ç±»
        $(this).addClass('active').siblings('.moti-color-option').removeClass('active');
        self.currentColor = $(this).data('color');
      });

      // é«˜äº®æŒ‰é’® - ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç›‘å¬åŠ¨æ€æ³¨å…¥çš„é«˜äº®æŒ‰é’®
      $(document).on('click', '.moti-highlight-btn', function (e) {
        e.stopPropagation();
        self.highlightSelection();
      });

      // æŸ¥çœ‹ç¬”è®°
      $(document).on('click', '#moti-show-notes-btn', function () {
        self.showNotesList();
      });

      // ä¿å­˜ç¬”è®°
      $(document).on('click', '#moti-save-note-btn', function () {
        self.saveNote();
      });

      // å–æ¶ˆ
      $(document).on('click', '#moti-cancel-btn, #moti-overlay', function () {
        self.closePanel();
      });

      // å…³é—­ç¬”è®°åˆ—è¡¨
      $(document).on('click', '#moti-close-notes-btn', function () {
        $('#moti-notes-list, #moti-overlay').hide();
      });
    },

    highlightSelection: function () {
      const selection = window.getSelection();
      if (!selection.rangeCount || selection.isCollapsed) {
        app.alertError('è¯·å…ˆé€‰ä¸­ä¸€æ®µæ–‡å­—');
        return;
      }

      const range = selection.getRangeAt(0);
      const selectedText = selection.toString().trim();

      if (!selectedText) {
        app.alertError('é€‰ä¸­çš„æ–‡å­—ä¸èƒ½ä¸ºç©º');
        return;
      }

      // ç¡®ä¿é€‰æ‹©åœ¨å¸–å­å†…å®¹åŒºåŸŸå†…
      const container = range.commonAncestorContainer;
      const postContent = $(container).closest('[component="post/content"]');
      if (postContent.length === 0) {
        app.alertError('è¯·åœ¨å¸–å­å†…å®¹ä¸­é€‰æ‹©æ–‡å­—');
        return;
      }

      this.currentSelection = {
        text: selectedText,
        range: range.cloneRange(),
        color: this.currentColor,
        postId: postContent.closest('[data-pid]').data('pid')
      };

      $('#moti-selected-text').text('"' + selectedText + '"');
      $('#moti-overlay, #moti-note-panel').show();
      $('#moti-note-input').val('').focus();

      // éšè—é€‰æ‹©å·¥å…·æç¤º
      $('[component="selection/tooltip"]').hide();
    },

    saveNote: async function () {
      const noteText = $('#moti-note-input').val().trim();

      if (!this.currentSelection) {
        return;
      }

      // åˆ›å»ºé«˜äº®å…ƒç´ 
      const span = document.createElement('span');
      span.className = 'moti-highlight';
      span.style.backgroundColor = this.currentSelection.color;
      span.style.padding = '2px 0';
      span.style.borderRadius = '3px';
      span.style.cursor = 'pointer';
      span.textContent = this.currentSelection.text;

      const postId = this.currentSelection.postId;
      const selectedText = this.currentSelection.text;
      const color = this.currentSelection.color;

      try {
        this.currentSelection.range.deleteContents();
        this.currentSelection.range.insertNode(span);
      } catch (e) {
        console.error('æ’å…¥é«˜äº®å¤±è´¥:', e);
        app.alertError('æ·»åŠ é«˜äº®å¤±è´¥ï¼Œè¯·é‡è¯•');
        this.closePanel();
        return;
      }

      // ä¿å­˜ç¬”è®°åˆ°æœåŠ¡å™¨
      try {
        const response = await fetch('/api/moti/notes', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          credentials: 'include',
          body: JSON.stringify({
            pid: postId,
            content: selectedText,
            note: noteText,
            startOffset: 0,
            endOffset: selectedText.length,
            color: color
          })
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'ä¿å­˜å¤±è´¥');
        }

        // ä¿å­˜ç¬”è®°åˆ°æœ¬åœ°åˆ—è¡¨
        const highlight = {
          id: result.data.noteId,
          text: selectedText,
          note: noteText,
          color: color,
          postId: postId,
          timestamp: new Date().toLocaleString('zh-CN')
        };

        this.highlights.push(highlight);
        this.updateNotesCount();

        this.closePanel();
        app.alertSuccess('ç¬”è®°å·²ä¿å­˜åˆ°æœåŠ¡å™¨ï¼');

        window.getSelection().removeAllRanges();
      } catch (error) {
        console.error('ä¿å­˜ç¬”è®°å¤±è´¥:', error);
        app.alertError('ä¿å­˜ç¬”è®°å¤±è´¥: ' + error.message);
        // å¦‚æœä¿å­˜å¤±è´¥ï¼Œç§»é™¤é«˜äº®
        span.remove();
      }
    },

    closePanel: function () {
      $('#moti-overlay, #moti-note-panel').hide();
      this.currentSelection = null;
    },

    showNotesList: function () {
      const container = $('#moti-notes-container');

      if (this.highlights.length === 0) {
        container.html('<p style="color: #999; text-align: center; padding: 20px;">è¿˜æ²¡æœ‰æ·»åŠ ä»»ä½•ç¬”è®°</p>');
      } else {
        let html = '';
        this.highlights.forEach((h) => {
          html += `
            <div style="
              background: white;
              border: 1px solid #dee2e6;
              border-left: 4px solid ${h.color};
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 15px;
            ">
              <div style="font-size: 14px; color: #666; margin-bottom: 8px; font-style: italic;">"${h.text}"</div>
              ${h.note ? `<div style="font-size: 15px; color: #333; margin-bottom: 8px;">${h.note}</div>` : '<div style="font-size: 14px; color: #999;">ï¼ˆæ— ç¬”è®°ï¼‰</div>'}
              <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${h.timestamp}</div>
              <button onclick="MotiHighlight.deleteNote(${h.id})" style="
                padding: 6px 12px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                background: #dc3545;
                color: white;
                font-size: 12px;
              ">åˆ é™¤</button>
            </div>
          `;
        });
        container.html(html);
      }

      $('#moti-notes-list, #moti-overlay').show();
    },

    deleteNote: async function (id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¬”è®°å—ï¼Ÿ')) return;

      try {
        const response = await fetch('/api/moti/notes/' + id, {
          method: 'DELETE',
          credentials: 'include'
        });

        const result = await response.json();

        if (!response.ok) {
          throw new Error(result.error || 'åˆ é™¤å¤±è´¥');
        }

        this.highlights = this.highlights.filter(h => h.id !== id);
        this.updateNotesCount();
        this.showNotesList();
        app.alertSuccess('ç¬”è®°å·²åˆ é™¤');
      } catch (error) {
        console.error('åˆ é™¤ç¬”è®°å¤±è´¥:', error);
        app.alertError('åˆ é™¤ç¬”è®°å¤±è´¥: ' + error.message);
      }
    },

    clearAllHighlights: async function () {
      if (this.highlights.length === 0) {
        app.alertError('æ²¡æœ‰å¯æ¸…é™¤çš„é«˜äº®');
        return;
      }

      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰é«˜äº®å’Œç¬”è®°å—ï¼Ÿè¿™å°†ä»æœåŠ¡å™¨åˆ é™¤æ‰€æœ‰ç¬”è®°ã€‚')) return;

      try {
        // åˆ é™¤æ‰€æœ‰ç¬”è®°
        for (const highlight of this.highlights) {
          await fetch('/api/moti/notes/' + highlight.id, {
            method: 'DELETE',
            credentials: 'include'
          });
        }

        this.highlights = [];
        this.updateNotesCount();
        app.alertSuccess('æ‰€æœ‰ç¬”è®°å·²æ¸…é™¤');
        window.location.reload();
      } catch (error) {
        console.error('æ¸…é™¤ç¬”è®°å¤±è´¥:', error);
        app.alertError('æ¸…é™¤ç¬”è®°å¤±è´¥: ' + error.message);
      }
    },

    updateNotesCount: function () {
      const count = this.highlights.length;
      const badge = $('#moti-notes-count');

      badge.text(count);

      if (count > 0) {
        badge.show();
      } else {
        badge.hide();
      }
    },

    loadNotes: async function () {
      if (!ajaxify.data.tid) {
        return;
      }

      try {
        // ä»æœåŠ¡å™¨åŠ è½½ç¬”è®°
        const response = await fetch('/api/moti/notes?page=1&limit=1000', {
          credentials: 'include'
        });

        if (!response.ok) {
          throw new Error('åŠ è½½ç¬”è®°å¤±è´¥');
        }

        const result = await response.json();

        if (result.success && result.data.notes) {
          // è¿‡æ»¤å‡ºå½“å‰å¸–å­çš„ç¬”è®°
          const postNotes = result.data.notes.filter(note => {
            // éœ€è¦è·å–å½“å‰å¸–å­çš„ pid
            // ä»é¡µé¢ä¸­è·å–æ‰€æœ‰ pid
            const pids = $('[data-pid]').map(function() {
              return $(this).data('pid');
            }).get();

            return pids.includes(parseInt(note.pid));
          });

          this.highlights = postNotes.map(note => ({
            id: note.noteId,
            text: note.content,
            note: note.note,
            color: note.color,
            postId: note.pid,
            timestamp: new Date(parseInt(note.timestamp)).toLocaleString('zh-CN')
          }));

          this.updateNotesCount();

          // æ¢å¤é«˜äº®æ˜¾ç¤º
          this.restoreHighlights();
        }
      } catch (error) {
        console.error('åŠ è½½ç¬”è®°å¤±è´¥:', error);
      }
    },

    restoreHighlights: function () {
      // åœ¨å†…å®¹ä¸­æ¢å¤é«˜äº®æ˜¾ç¤º
      // æ³¨æ„ï¼šè¿™ä¸ªåŠŸèƒ½æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦å‡†ç¡®å®šä½æ–‡å­—ä½ç½®
      // ç®€åŒ–å®ç°ï¼šåªæ˜¾ç¤ºç¬”è®°åˆ—è¡¨ï¼Œä¸æ¢å¤é«˜äº®
      console.log('ç¬”è®°å·²ä»æœåŠ¡å™¨åŠ è½½ï¼Œå…± ' + this.highlights.length + ' æ¡');
    }
  };

  // æš´éœ²åˆ°å…¨å±€
  window.MotiHighlight = MotiHighlight;

  // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
  $(document).ready(function () {
    $(window).on('action:ajaxify.end', function () {
      MotiHighlight.init();
    });

    // é¦–æ¬¡åŠ è½½
    MotiHighlight.init();
  });
})();
